<!doctype html><html lang=en itemscope itemtype=http://schema.org/WebPage><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel=icon href=/images/LTS.png><title>Handling Locked M365 Files in Power Automate - Lindsay T Shelton</title><meta name=description content="Sometimes, late at night, I awaken, covered in sweat, fresh from another nightmare about Power Automate flows that interact with SharePoint document libraries. Because what happens when you try to make changes to that document library, oh so innocently, when yet another innocent person has - gasp - the file open? Then Power Automate and SharePoint both respectively freak out at you and nothing can get done until that document is cleared out."><meta name=author content="Lindsay Shelton"><meta name=generator content="Hugo 0.108.0"><link rel=stylesheet href="https://blist.vercel.app/css/styles.min.c0846aac9db6c87efe354bad93a5e4432ef35cc12598aeed07df50323381cc06.css" integrity="sha256-wIRqrJ22yH7+NUutk6XkQy7zXMElmK7tB99QMjOBzAY="><meta property="og:title" content="Handling Locked M365 Files in Power Automate"><meta property="og:description" content="Sometimes, late at night, I awaken, covered in sweat, fresh from another nightmare about Power Automate flows that interact with SharePoint document libraries. Because what happens when you try to make changes to that document library, oh so innocently, when yet another innocent person has - gasp - the file open? Then Power Automate and SharePoint both respectively freak out at you and nothing can get done until that document is cleared out."><meta property="og:type" content="article"><meta property="og:url" content="https://blist.vercel.app/blog/202306handling-locked-m365-files-in-power-automate/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2023-06-26T14:49:05-05:00"><meta property="article:modified_time" content="2023-06-26T14:49:05-05:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Handling Locked M365 Files in Power Automate"><meta name=twitter:description content="Sometimes, late at night, I awaken, covered in sweat, fresh from another nightmare about Power Automate flows that interact with SharePoint document libraries. Because what happens when you try to make changes to that document library, oh so innocently, when yet another innocent person has - gasp - the file open? Then Power Automate and SharePoint both respectively freak out at you and nothing can get done until that document is cleared out."><meta itemprop=name content="Handling Locked M365 Files in Power Automate"><meta itemprop=description content="Sometimes, late at night, I awaken, covered in sweat, fresh from another nightmare about Power Automate flows that interact with SharePoint document libraries. Because what happens when you try to make changes to that document library, oh so innocently, when yet another innocent person has - gasp - the file open? Then Power Automate and SharePoint both respectively freak out at you and nothing can get done until that document is cleared out."><meta itemprop=datePublished content="2023-06-26T14:49:05-05:00"><meta itemprop=dateModified content="2023-06-26T14:49:05-05:00"><meta itemprop=wordCount content="1132"><meta itemprop=keywords content="power automate,how to,error handling,SharePoint,"></head><body class="dark:bg-gray-800 dark:text-white relative flex flex-col min-h-screen"><header class="container flex justify-between md:justify-between gap-4 flex-wrap p-6 mx-auto relative"><a href=https://blist.vercel.app/ class="capitalize font-extrabold text-2xl"><img src=/images/LTS2.png alt="Lindsay T Shelton" class="h-8 max-w-full"></a>
<button class="mobile-menu-button md:hidden"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><line x1="4" y1="8" x2="20" y2="8"/><line x1="4" y1="16" x2="20" y2="16"/></svg></button><ul class="mobile-menu absolute z-10 px-6 pb-6 md:p-0 top-full left-0 w-full md:w-auto md:relative hidden md:flex flex-col md:flex-row items-end md:items-center gap-4 lg:gap-6 bg-white dark:bg-gray-800"><li><a href=/blog>Blog</a></li><li><a href=/page/about/>About</a></li><li><a href=/tags>Tags</a></li><li class="grid place-items-center"><span class="open-search inline-block cursor-pointer"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg></span></li><li class="grid place-items-center"><span class="toggle-dark-mode inline-block cursor-pointer"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="3"/><line x1="12" y1="5" x2="12" y2="5.01"/><line x1="17" y1="7" x2="17" y2="7.01"/><line x1="19" y1="12" x2="19" y2="12.01"/><line x1="17" y1="17" x2="17" y2="17.01"/><line x1="12" y1="19" x2="12" y2="19.01"/><line x1="7" y1="17" x2="7" y2="17.01"/><line x1="5" y1="12" x2="5" y2="12.01"/><line x1="7" y1="7" x2="7" y2="7.01"/></svg></span></li></ul></header><main class=flex-1><article class="prose lg:prose-lg mx-auto my-8 dark:prose-dark px-4"><h1 class="text-2xl font-bold mb-2">Handling Locked M365 Files in Power Automate</h1><h5 class="text-sm flex items-center flex-wrap"><svg xmlns="http://www.w3.org/2000/svg" class="mr-1" width="16" height="16" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><rect x="4" y="5" width="16" height="16" rx="2"/><line x1="16" y1="3" x2="16" y2="7"/><line x1="8" y1="3" x2="8" y2="7"/><line x1="4" y1="11" x2="20" y2="11"/><rect x="8" y="15" width="2" height="2"/></svg>Posted on
June 26, 2023
&nbsp;&bull;&nbsp;<svg xmlns="http://www.w3.org/2000/svg" class="mr-1" width="16" height="16" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg>
6&nbsp;minutes
&nbsp;&bull;<svg xmlns="http://www.w3.org/2000/svg" class="mx-1" width="16" height="16" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 19a9 9 0 019 0 9 9 0 019 0"/><path d="M3 6a9 9 0 019 0 9 9 0 019 0"/><line x1="3" y1="6" x2="3" y2="19"/><line x1="12" y1="6" x2="12" y2="19"/><line x1="21" y1="6" x2="21" y2="19"/></svg>
1132&nbsp;words</h5><details id=TableOfContents class="px-4 mt-4 bg-gray-100 dark:bg-gray-700 rounded toc"><summary class="flex items-center font-bold py-2 px-4 cursor-pointer justify-between select-none text-black dark:text-white"><span>Table of contents</span><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-chevron-down" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><polyline points="6 9 12 15 18 9"/></svg></summary><ul class="mt-2 pb-4"><li><a href=#the-background>The Background</a></li><li><a href=#the-basic-structure>The Basic Structure</a></li><li><a href=#breaking-it-down>Breaking It Down</a></li></ul></details><p>Sometimes, late at night, I awaken, covered in sweat, fresh from another nightmare about Power Automate flows that interact with SharePoint document libraries. Because what happens when you try to make changes to that document library, oh so innocently, when yet another innocent person has - gasp - the file open? Then Power Automate and SharePoint both respectively freak out at you and nothing can get done until that document is cleared out. SharePoint just gets up and faints at the thought of letting you edit a column of that library, and then Power Automate just walks right out the door, never to be seen again. Chaos ensues.</p><p>Okay, maybe that&rsquo;s too dramatic of a retelling for the post that is re-launching my blog. I will say this: if you try to do anything to a SharePoint document library while someone has the document open, just stop because you can&rsquo;t do anything. Anything at all.</p><p>So, even though I&rsquo;d love to get over this recurring nightmare, I can&rsquo;t help you with a certain basic level of freaking out. I can, however, let you know that SharePoint is freaking out and prevent losing any of your data or information, through this error handling pattern in Power Automate!</p><h2 id=the-background>The Background</h2><p>So I have built three SOP document libraries now in SharePoint for various groups at my work. Each of those SOP libraries runs on a series of Power Automate flows to handle reviewing, voting on, and approving these SOPs whenever appropriate, in addition to being a repository for the SOPs for reference.</p><p>When one of our users runs an approval flow, there are certain things recorded in the SharePoint doc library for record keeping purposes - who was this sent to once it&rsquo;s sent out, and then what was their verdict, comments, and when did they approve or rejct it. I need to record all of this, but WITHOUT error handling built in, the Power Automate flow would just STOP as soon as it encounters a file that is &ldquo;locked for editing&rdquo;.</p><p>The person with the file open isn&rsquo;t purposely locking the file - that&rsquo;s just the default behavior when someone has the file open. Now because the flow would stop when it tries to make a change to the SharePoint doc library, I&rsquo;d lose all of that data I was trying to copy, in addition to the fact that the flow has stopped running and I&rsquo;d have to restart the whole thing. All in all, not an ideal user experience.</p><p>Thus, error handling!</p><h2 id=the-basic-structure>The Basic Structure</h2><p>For every SharePoint action that I&rsquo;m going to utilize, I am going to need to initialize a variable. This isn&rsquo;t fancy - it&rsquo;s just a boolean set to &ldquo;false&rdquo; using the expression editor (so not just typing in the word &ldquo;false&rdquo;). In this example flow, I&rsquo;ve got two that I will call updateMetadata:</p><p><img src=/images/handling-locked-m365-files-in-power-automate1.png alt=Placeholder></p><p>When I say to use the expression editor, I literally mean in the &ldquo;value&rdquo; field, switch from Dynamic content to Expression, type in the word &ldquo;false&rdquo; with no quotation marks, and click the blue OK button.</p><p><img src=/images/handling-locked-m365-files-in-power-automate2.png alt=Placeholder></p><p>This value is set to false and will remain set to false until an action interacting with SharePoint is successful. Basically, each updateMetadata gets its own Do Until loop.</p><p><img src=/images/handling-locked-m365-files-in-power-automate3.png alt=Placeholder></p><p>Everything that is in the loop will repeat, sort of (wait for the Configure run after pieces!) until something in the loop turns the value of updateMetadata from false to true. Once the value is set to true and it reaches the top of the loop again, the loop will break or stop and the flow will continue on as desired.</p><h2 id=breaking-it-down>Breaking It Down</h2><p>So, I have the loop in this picture present because of the Update file properties action. That action, if the file in question was open somewhere, would throw an error.</p><p>Thus, the next action, Send an email (V2) that the file is locked. Notice that the arrow into that action is red and dashed. That indicates that there is a Run after configured.</p><p>Click the three horizontal dots and click &ldquo;Configure run after&rdquo;. Your screen will then look like this:</p><p><img src=/images/handling-locked-m365-files-in-power-automate4.png alt=Placeholder></p><p>By default, every action is configured to run after the previous action is successful. We can change that. Uncheck the box next to &ldquo;is successful&rdquo; in this case and check the boxes next to &ldquo;has failed&rdquo; and &ldquo;has timed out&rdquo;. Make sure to click the blue Done button.</p><p>Now if that SharePoint action fails or times out, this action will trigger and an email will be sent. If I am able to update SharePoint with no problems? No email is sent and that action is skipped. With me so far?</p><p>For your reference, here&rsquo;s the email I send out. It goes to the user who triggered the flow and lets them know the name of the file that appears to be locked:</p><p><img src=/images/handling-locked-m365-files-in-power-automate5.png alt=Placeholder></p><p>My next action is another SharePoint action that doesn&rsquo;t initially appear to do anything (Update file properties).</p><p><img src=/images/handling-locked-m365-files-in-power-automate6.png alt=Placeholder></p><p>That&rsquo;s fine. I just want to know if the file is still locked. You could add a delay in front of this one if you wanted, but I have a delay right after that accomplishes the same thing.</p><p>Click the three horizontal dots next to the Update file properties SharePoint action and click &ldquo;Configure run after&rdquo; again. For this one, check all four boxes. Whether the email is sent or not, I want it to check SharePoint again to see if I can edit the doc library yet.</p><p>On the first loop especially, this is probably going to fail, which is what the next two actions are for.</p><p><img src=/images/handling-locked-m365-files-in-power-automate7.png alt=Placeholder></p><p>I put in a 10 minute delay - make yours longer or shorter as you desire, but keep in mind that those emails will start to get annoying. 10 minutes has been a good median time for us - it doesn&rsquo;t totally stop the workflow but it does give people time to check the file and ping people to get out of it.</p><p>For the Configure run after for the Delay action, only check &ldquo;has failed&rdquo; and &ldquo;has timed out&rdquo;. We only want to wait the 10 minutes if we couldn&rsquo;t update SharePoint.</p><p>Then, lastly, there&rsquo;s a Set variable action for that updateMetadata variable. We now want to set it to true (remember to use the expression editor), but ONLY if the previous Delay action was skipped. So, for the Set variable Configure run after, set that to just &ldquo;is skipped&rdquo; with no other boxes checked. Yours should be like this for the last two actions:</p><p><img src=/images/handling-locked-m365-files-in-power-automate8.png alt=Placeholder></p><p>Click the blue &ldquo;Done&rdquo; button on both and get ready to test (might want to set the Delay shorter for testing).</p><p>I&rsquo;ve been using this error handling loop with great success for 2 years - I hope it also brings you success!</p><script async src="https://www.googletagmanager.com/gtag/js?id=G-CN3PDT3T20"></script>
<script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-CN3PDT3T20")</script><blockquote></blockquote></article><div class="px-2 mb-2"><script src=https://giscus.app/client.js data-repo data-repo-id data-category data-category-id data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=bottom data-theme=preferred_color_scheme data-lang=en crossorigin=anonymous async></script></div><div class="bg-pink-100 dark:bg-gray-900"><div class="container px-4 py-12 mx-auto max-w-4xl grid grid-cols-1 md:grid-cols-2 gap-4 items-center"><div><div class="text-2xl font-bold mb-2">Follow me</div><p class=opacity-60>Follow along for Power Platform, M365, and cat goodness</p></div><ul class="flex justify-center gap-x-3 flex-wrap gap-y-2"><li><a href=https://linkedin.com/in/lindsaytshelton target=_blank rel=noopener aria-label=LinkedIn class="p-1 inline-block rounded-full border border-transparent text-gray-500 hover:text-gray-800 hover:border-gray-800 cursor-pointer transition-colors dark:text-gray-600 dark:hover:border-gray-300 dark:hover:text-gray-300"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><rect x="4" y="4" width="16" height="16" rx="2"/><line x1="8" y1="11" x2="8" y2="16"/><line x1="8" y1="8" x2="8" y2="8.01"/><line x1="12" y1="16" x2="12" y2="11"/><path d="M16 16v-3a2 2 0 00-4 0"/></svg></a></li></ul></div></div></main><footer class="container p-6 mx-auto flex justify-between items-center"><span class="text-sm font-light">Copyright © 2024 - Lindsay Shelton · All rights reserved</span>
<span onclick='window.scrollTo({top:0,behavior:"smooth"})' class="p-1 cursor-pointer"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M18 15l-6-6-6 6h12"/></svg></span></footer><div class="search-ui absolute top-0 left-0 w-full h-full bg-white dark:bg-gray-800 hidden"><div class="container max-w-3xl mx-auto p-12"><div class=relative><div class="my-4 text-center text-2xl font-bold">Search</div><span class="p-2 absolute right-0 top-0 cursor-pointer close-search"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></span></div><input type=search class="py-2 px-3 w-full dark:text-black border dark:border-transparent" placeholder="Enter search query"><div class="search-results text-lg font-medium my-4 hidden">Results</div><ul class="search-list my-2"></ul><div class="no-results text-center my-8 hidden"><div class="text-xl font-semibold mb-2">No results found</div><p class="font-light text-sm">Try adjusting your search query</p></div></div></div><script src=https://blist.vercel.app/js/scripts.min.js></script>
<script>const darkmode=document.querySelector(".toggle-dark-mode");function toggleDarkMode(){document.documentElement.classList.contains("dark")?(document.documentElement.classList.remove("dark"),localStorage.setItem("darkmode","light")):(document.documentElement.classList.add("dark"),localStorage.setItem("darkmode","dark"))}darkmode&&darkmode.addEventListener("click",toggleDarkMode);const darkStorage=localStorage.getItem("darkmode"),isBrowserDark=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches;!darkStorage&&isBrowserDark&&document.documentElement.classList.add("dark"),darkStorage&&darkStorage==="dark"&&toggleDarkMode()</script><script>const mobileMenuButton=document.querySelector(".mobile-menu-button"),mobileMenu=document.querySelector(".mobile-menu");function toggleMenu(){mobileMenu.classList.toggle("hidden"),mobileMenu.classList.toggle("flex")}mobileMenu&&mobileMenuButton&&mobileMenuButton.addEventListener("click",toggleMenu)</script></body></html>